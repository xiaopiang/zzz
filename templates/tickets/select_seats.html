<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸æ“‡åº§ä½</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/seat.css">
</head>
<style>  /* è¢å¹•æ¨£å¼ */
    /* è¢å¹•æ¨£å¼ */
    .screen {
        background: linear-gradient(to bottom, #555, #ccc);
        height: 25px;
        border-radius: 50%/100% 100% 0 0;
        width: 80%;
        margin: 0 auto 40px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .screen:after {
        content: "è¢å¹•";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #fff;
        font-weight: bold;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

        /* Seat Container */
        .seat-container {
            max-width: 800px;
            margin: 0 auto;
            perspective: 1000px;
        }
    
        .seat-layout {
            transform: rotateX(10deg);
            transform-origin: top;
        }
        
        table {
            border-collapse: collapse; /* åˆä½µé‚Šæ¡† */
        }
        
        td {
            border: none; /* ç§»é™¤å–®å…ƒæ ¼é‚Šæ¡† */
        }      

        /* Table styling for seat layout */
        table.seat-table {
            margin: 0 auto;
            border-collapse: separate;
            border-spacing: 5px;
        }
    
        /* Seat Styling */
        td p {
            margin: 0;
            text-align: center;
        }
    
        td {
            position: relative;
            text-align: center;
        }
    
        td img {
            display: block;
            margin: 0 auto;
            cursor: pointer;
            transition: transform 0.2s;
        }
    
        td img:hover {
            transform: scale(1.1);
        }
    
        /* Row label styling */
        td.row-label {
            font-weight: bold;
            width: 30px;
            color: #555;
            vertical-align: middle;
        }
    
        /* Status-based styling */
        img[src="../img/standard_available.png"] {
            cursor: pointer;
        }
    
        img[src="../img/standard_selected.png"] {
            cursor: pointer;
        }
    
        img[src="../img/standard_unavailable.png"] {
            cursor: not-allowed;
            opacity: 0.7;
        }
    
        /* Timer Styling */
        .timer {
            font-size: 1.2rem;
            font-weight: bold;
            color: #d32f2f;
        }
    
        .timer.warning {
            animation: pulse 1s infinite;
        }
    
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    
        /* Legend Styling */
        .seat-legend {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
    
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 15px 10px;
        }
    
        .legend-box {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
    
        /* Summary Card */
        .summary-card {
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            border: none;
        }
    
        .summary-card.has-selections {
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
    
        #selected-seats {
            min-height: 30px;
            margin-top: 5px;
            border: none;
        }
    
        .badge.bg-primary {
            background-color: #2196F3 !important;
            padding: 6px 10px;
            margin-bottom: 5px;
        }
    
        /* Buttons */
        .btn-success {
            background-color: #4CAF50;
            border-color: #4CAF50;
            transition: all 0.2s;
        }
    
        .btn-success:hover:not([disabled]) {
            background-color: #388E3C;
            border-color: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    
        .btn-success:disabled {
            background-color: #A5D6A7;
            border-color: #A5D6A7;
            cursor: not-allowed;
        }
    
        /* Responsive adjustments */
        @media (max-width: 768px) {
            table.seat-table td {
                padding: 2px;
            }
            
            table.seat-table td p {
                font-size: 0.8rem;
            }
            
            table.seat-table td img {
                width: 20px;
                height: 20px;
            }
            
            .summary-card .row {
                flex-direction: column;
            }
            
            .summary-card .col-md-4 {
                width: 100%;
                text-align: center !important;
                margin-bottom: 15px;
            }
        }
    
        /* Add seat labels */
        .row-label {
            font-weight: bold;
            padding-right: 10px;
        }
        .position-sticky {
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 10;
          }
        .container, .row {
            overflow: visible !important;
        }
    
</style>   
<body>
    <section class="main-container">
        <div class="container">
            <form action="/LiveTicket/Home/SelectSeats" method="post" autocomplete="off">
              <div class="row">
                <!-- å·¦å´ä¸»å…§å®¹å€ -->
                <div class="col-lg-8">
                  <div class="panel">
                    <div class="panel-body">
                      <div class="row">
                        <div class="col-md-2 col-sm-3 col-xs-3">
                          <div class="abordered-class text-center">
                            <div class="c-bg"><h4>12+</h4></div>
                            <div><h5>è¼”12ç´š</h5></div>
                          </div>
                        </div>
                        <div class="col-sm-9 col-lg-7 col-md-6 col-xs-9">
                          <h3><strong>{{ showtime.movie.title }}</strong></h3>
                          <p>{{ showtime.movie.title }}</p>
                        </div>
                        <div class="col-sm-12 col-lg-3 col-md-4 col-xs-12">
                          <div class="body">
                            <p class="text-primary"><i class="fa fa-clock-o pr-10"></i> {{ showtime.start_time|date:"Y/m/dï¼ˆDï¼‰ H:i" }}</p>
                            <p class="text-primary"><i class="fa fa-location-arrow pr-10"></i> {{ showtime.theater.name }}</p>
                            <p class="text-primary"><i class="fa fa-video-camera pr-10"></i> ç¬¬Aå€</p>
                          </div>
                        </div>
                      </div> <!-- çµæŸ row -->
                    </div> <!-- çµæŸ panel-body -->
                  </div> <!-- çµæŸ panel -->
                </div> <!-- çµæŸ col-lg-8 -->
          
                <!-- å³å´å´é‚Šæ¬„ï¼ˆæœƒå“¡+è³¼ç‰©æ¸…å–®ï¼‰ -->
                <div class="col-lg-4">
                  <div class="position-sticky" style="top: 20px; z-index: 10;">
                    <!-- æœƒå“¡å°ˆå€ -->
                    <div class="panel mb-3">
                      <div class="panel-heading">
                        <h4 class="panel-title"><i class="fa fa-user me-2"></i> æœƒå“¡å°ˆå€</h4>
                      </div>
                      <div class="panel-body">
                        <p>å°šæœªç™»å…¥</p>
                        <p class="text-primary"><i class="fa fa-info-circle me-1"></i> <strong>è«‹ç«‹å³ç™»å…¥æœƒå“¡</strong></p>
                        <p>å„²å€¼é‡‘æ¶ˆè²»äº«æœƒå“¡ç¥¨åƒ¹åŠé¤é£²å„ªæƒ </p>
                        <a href="{% url 'tickets:login' %}?next={{ request.get_full_path }}" class="btn btn-primary btn-member-login w-100 mt-2">
                            <i class="fa fa-sign-in-alt me-2"></i> æœƒå“¡ç™»å…¥
                          </a>
                      </div>
                    </div>
          
                    <!-- è³¼ç‰©æ¸…å–® -->
                    <div class="panel">
                      <div class="panel-heading">
                        <h4 class="panel-title"><i class="fa fa-shopping-cart me-2"></i> è³¼ç‰©æ¸…å–®</h4>
                      </div>
                      <div class="panel-body">
                        <table class="table" id="OrderInfo">
                          <thead>
                            <tr>
                              <th>å•†å“åç¨±</th>
                              <th>æ•¸é‡</th>
                              <th>åƒ¹æ ¼</th>
                            </tr>
                          </thead>
                          <tbody id="cartItems">
                            <!-- è³¼ç‰©æ¸…å–®é …ç›®å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
                          </tbody>
                          <tfoot>
                            <tr>
                              <td colspan="2" class="text-end">åˆè¨ˆ</td>
                              <td><span id="spTotalPrice" class="fw-bold">0</span></td>
                            </tr>
                          </tfoot>
                        </table>
                        
                      </div>
                    </div>
                  </div> <!-- çµæŸ sticky å€å¡Š -->
                </div> <!-- çµæŸ col-lg-4 -->
              </div> <!-- çµæŸ row -->
            </form>
          </div> <!-- çµæŸ container -->
          
    </section>


<div class="mb-4">
    <h1 class="text-center">é¸æ“‡åº§ä½</h1>
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-1">{{ showtime.movie.title }}</h5>
                    <p class="mb-0"><i class="bi bi-building"></i> {{ showtime.theater.name }} - {{ showtime.start_time|date:"Yå¹´mæœˆdæ—¥ H:i" }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="seat-legend">
    <div class="legend-item">
        <div class="legend-box" style="background-color:rgb(238, 10, 10); border: 1px solid #ccc;"></div>
        <span>å·²å”®å‡º</span>
    </div>
    <div class="legend-item">
        <div class="legend-box" style="background-color: #e0e0e0; border: 1px solid #ccc;"></div>
        <span>å¯é¸æ“‡</span>
    </div>
    <div class="legend-item">
        <div class="legend-box" style="background-color:rgb(68, 133, 202); border: 1px solid #1976D2;"></div>
        <span>å·²é¸æ“‡</span>
    </div>
</div>

<div class="text-center mb-4">
    <div class="screen"></div>
</div>
<div id="showtime-id" data-showtime-id="{{ showtime.id }}"></div>
<table class="seat-table">
    <tbody>
        {% for row, seats in seat_rows %}
        <tr>
            <td class="row-label">{{ row }}</td>
            {% for seat in seats %}
            <td class="seat-cell" {% if seat.status == 'sold' %}bg-danger{% endif %}"
                data-seat-id="{{ seat.id }}"
                data-status="{{ seat.status }}">
                <input type="checkbox"
                       class="seat-checkbox"
                       {% if seat.status == 'sold' %}disabled{% endif %}
                       {% if seat.status == 'selected' %}checked{% endif %}>
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>


<div class="card mb-4 summary-card {% if user_reserved_seats %}has-selections{% endif %}">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h5><i class="bi bi-check-circle-fill text-primary"></i> é¸æ“‡åº§ä½: <span id="selected-count">{{ user_reserved_seats|length }}</span></h5>
                <h5>å¯é¸åº§ä½å‰©é¤˜ï¼š<span id="available-count" data-total="{{ available_count }}">{{ available_count }}</span></h5>

            </div>
            <div class="col-md-4 text-center">
                <div id="timer-container" class="timer">
                    <i class="bi bi-clock"></i> å‰©é¤˜é è¨‚æ™‚é–“: <span id="timer">15:00</span>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <h5 class="mb-3">ç¸½åƒ¹: NT$ <span id="total-price">{{total_price|default:0  }}</span></h5>
                <button id="proceed-btn" class="btn btn-success btn-lg"
            data-logged-in="{{ is_logged_in|yesno:'true,false' }}">
            <i class="bi bi-cart-check"></i> ç¢ºèªè¨‚å–®
</button>


            </div>
            
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("âœ… åº§ä½é¸æ“‡ JS è¼‰å…¥å®Œæˆ");
    
        const seats = document.querySelectorAll(".seat-checkbox");
        const showtimeIdElement = document.getElementById("showtime-id");
    
        if (!showtimeIdElement) {
            console.error("æ‰¾ä¸åˆ°å ´æ¬¡ ID å…ƒç´  (#showtime-id)ï¼Œè«‹æª¢æŸ¥ HTML");
            return;
        }
    
        const showtimeId = showtimeIdElement.dataset.showtimeId;  // å–å¾—å ´æ¬¡ ID
    
        seats.forEach(seat => {
            seat.addEventListener("change", function () {
                // âœ… å¦‚æœè¢«é¸ä¸­ï¼Œå…ˆå–æ¶ˆå…¶ä»–å·²é¸çš„
                if (this.checked) {
                    seats.forEach(other => {
                        if (other !== this) {
                            other.checked = false;
                        }
                    });
                }
        
                // ä»¥ä¸‹åŸæœ¬çš„é‚è¼¯ç…§èˆŠ
                let seatCell = this.parentElement;
                let seatId = seatCell.dataset.seatId;
                let isSold = seatCell.dataset.status === "sold";
        
                if (!seatId) {
                    console.error("ç¼ºå°‘åº§ä½ IDï¼Œè«‹æª¢æŸ¥ HTML çµæ§‹");
                    return;
                }
        
                if (isSold) {
                    console.warn("é€™å€‹åº§ä½å·²å”®å‡ºï¼Œç„¡æ³•é¸æ“‡");
                    return;
                }
        
                let isSelected = this.checked;
        
                fetch(`/tickets/api/select_seat/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify({
                        showtime_id: showtimeId,
                        seat_id: seatId,
                        action: isSelected ? "select" : "cancel"
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert("åº§ä½é¸æ“‡å¤±æ•—ï¼š" + data.message);
                        this.checked = !this.checked;
                    }
                })
                .catch(error => console.error("é¸æ“‡åº§ä½æ™‚ç™¼ç”ŸéŒ¯èª¤:", error));
        
                updateSelectedCount();
                updateAvailableCount();
            });
        });
    
        // **ç²å– CSRF Token (Django å¿…é ˆ)**
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                let cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        // **è®€å–ä¸¦æ›´æ–°ç¸½åƒ¹**
        console.log("ğŸ”¹ å˜—è©¦è®€å–ç¸½åƒ¹...");
        const urlParams = new URLSearchParams(window.location.search);
        let totalPrice = urlParams.get("total_price") || 0;
    
        // ç¢ºä¿è½‰æ›æˆæ•¸å­—æ ¼å¼
        totalPrice = parseInt(totalPrice);
        if (isNaN(totalPrice)) {
            totalPrice = 0;
        }
    
        // æ›´æ–°ç¸½åƒ¹åˆ° HTML
        const totalPriceElement = document.getElementById("spTotalPrice");
        if (totalPriceElement) {
            totalPriceElement.textContent = totalPrice.toLocaleString();
            console.log("âœ… ç¸½åƒ¹å·²æˆåŠŸè®€å–ä¸¦æ›´æ–°ï¼š", totalPrice);
        } else {
            console.error("âŒ æ‰¾ä¸åˆ° `#spTotalPrice` å…ƒç´ ï¼Œè«‹æª¢æŸ¥ HTML");
        }
    });
    function updateSelectedCount() {
        const checkedBoxes = document.querySelectorAll(".seat-checkbox:checked");
        document.getElementById("selected-count").textContent = checkedBoxes.length;
    }
    function updateAvailableCount() {
        const totalAvailable = parseInt(document.getElementById("available-count").dataset.total);
        const selectedCount = document.querySelectorAll(".seat-checkbox:checked").length;
        const remaining = totalAvailable - selectedCount;
    
        document.getElementById("available-count").textContent = remaining;
    }
    document.getElementById("proceed-btn").addEventListener("click", function () {
        const isLoggedIn = this.dataset.loggedIn === "true";
    
        if (!isLoggedIn) {
            alert("è«‹å…ˆç™»å…¥æ‰èƒ½ç¢ºèªè¨‚å–®");
            window.location.href = "/tickets/login/?next=" + window.location.pathname + window.location.search;
            return;
        }
    
            // å·²ç™»å…¥ï¼Œè·³è½‰åˆ°ä»˜æ¬¾é é¢
            const showtimeId = {{ showtime.id }};
            const totalPrice = {{ total_price|default:0 }};
            
            // é€™è£¡ä½¿ç”¨ä»˜æ¬¾é é¢ï¼Œä¸¦å°‡è¨‚å–®ç¸½åƒ¹åƒæ•¸å‚³ééå»
            window.location.href = `/tickets/payment/${showtimeId}/?total_price=${totalPrice}`;
    });
</script>

</body>